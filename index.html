<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>PDV Cosméticos — Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6f42c1">

  <style>
    :root{--roxao:#6f42c1}
    body{background:#f8f9fa}
    .menu{width:260px;min-height:100vh;background:var(--roxao);color:#fff;position:fixed;inset:0 auto 0 0;padding:20px}
    .menu a{display:block;color:#fff;text-decoration:none;padding:10px 12px;margin:6px 0;border-radius:10px}
    .menu a.active,.menu a:hover{background:#55339e}
    .content{margin-left:280px;padding:20px}
    .card{border-radius:14px}
    /* Esconder cartões por padrão (serão mostrados via toggleCard) */
    #dashboardCard,#vendasCard,#produtosCard,#clientesCard,#relatoriosCard,#historico,#caixaCard,#comprovante,#configCard{display:none}
    /* Cupom não fiscal */
    #cupom{font-family:monospace;white-space:pre-wrap;background:#fff;padding:10px;border:1px dashed #ccc;max-width:360px;margin:auto}
    @media print{
      body *{visibility:hidden}
      #cupom,#cupom *{visibility:visible}
      #cupom{position:absolute;left:0;top:0;width:80mm;font-size:12px;line-height:1.3}
    }
    @media (max-width: 768px) {
      .content { margin-left: 0; margin-top: 70px; }
      .menu{display:none}
    }
    .fab{ position:fixed; right:16px; bottom:16px; z-index:1050; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.18); }
  </style>
</head>
<body>
  <!-- NAVBAR MOBILE -->
  <nav class="navbar navbar-dark bg-primary d-md-none">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuMobile">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="navbar-brand mb-0 h5">PDV Cosméticos</span>
    </div>
  </nav>

  <!-- MENU DESKTOP -->
  <aside class="menu d-none d-md-block">
    <h4 class="mb-3"><i class="bi bi-shop"></i> PDV</h4>
    <a onclick="toggleCard('dashboardCard',this)" class="active"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a onclick="toggleCard('vendasCard',this)"><i class="bi bi-cart"></i> Vendas</a>
    <a onclick="toggleCard('produtosCard',this)"><i class="bi bi-box-seam"></i> Produtos</a>
    <a onclick="toggleCard('clientesCard',this)"><i class="bi bi-people"></i> Clientes</a>
    <a onclick="toggleCard('relatoriosCard',this)"><i class="bi bi-graph-up-arrow"></i> Relatórios</a>
    <a onclick="toggleCard('historico',this)"><i class="bi bi-receipt"></i> Histórico</a>
    <a onclick="toggleCard('caixaCard',this)"><i class="bi bi-cash-coin"></i> Caixa</a>
    <a onclick="toggleCard('comprovante',this)"><i class="bi bi-printer"></i> Comprovante</a>
    <a onclick="toggleCard('configCard',this)"><i class="bi bi-gear"></i> Configurações</a>
  </aside>

  <!-- MENU MOBILE (Offcanvas) -->
  <div class="offcanvas offcanvas-start bg-primary text-white" tabindex="-1" id="menuMobile">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title"><i class="bi bi-shop"></i> PDV</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <a onclick="toggleCard('dashboardCard',this)" class="d-block text-white mb-2"><i class="bi bi-speedometer2"></i> Dashboard</a>
      <a onclick="toggleCard('vendasCard',this)" class="d-block text-white mb-2"><i class="bi bi-cart"></i> Vendas</a>
      <a onclick="toggleCard('produtosCard',this)" class="d-block text-white mb-2"><i class="bi bi-box-seam"></i> Produtos</a>
      <a onclick="toggleCard('clientesCard',this)" class="d-block text-white mb-2"><i class="bi bi-people"></i> Clientes</a>
      <a onclick="toggleCard('relatoriosCard',this)" class="d-block text-white mb-2"><i class="bi bi-graph-up-arrow"></i> Relatórios</a>
      <a onclick="toggleCard('historico',this)" class="d-block text-white mb-2"><i class="bi bi-receipt"></i> Histórico</a>
      <a onclick="toggleCard('caixaCard',this)" class="d-block text-white mb-2"><i class="bi bi-cash-coin"></i> Caixa</a>
      <a onclick="toggleCard('comprovante',this)" class="d-block text-white mb-2"><i class="bi bi-printer"></i> Comprovante</a>
      <a onclick="toggleCard('configCard',this)" class="d-block text-white mb-2"><i class="bi bi-gear"></i> Configurações</a>
    </div>
  </div>

  <!-- CONTEÚDO -->
  <main class="content">
    <div class="container-fluid">
      <h2 class="mb-3 d-flex align-items-center gap-2">
        <i class="bi bi-cart4"></i> PDV Cosméticos — Pro
        <span class="badge bg-light text-dark">Novo</span>
      </h2>

      <!-- DASHBOARD -->
      <div id="dashboardCard" class="card p-3">
        <div class="row g-3">
          <div class="col-6 col-md-3"><div class="card p-3 text-center"><div class="small text-muted">Vendas (Mês)</div><div class="fs-4 fw-bold" id="kpiVendasMes">0</div></div></div>
          <div class="col-6 col-md-3"><div class="card p-3 text-center"><div class="small text-muted">Faturamento (Mês)</div><div class="fs-4 fw-bold" id="kpiFatMes">R$ 0,00</div></div></div>
          <div class="col-6 col-md-3"><div class="card p-3 text-center"><div class="small text-muted">Clientes</div><div class="fs-4 fw-bold" id="kpiClientes">0</div></div></div>
          <div class="col-6 col-md-3"><div class="card p-3 text-center"><div class="small text-muted">Produtos</div><div class="fs-4 fw-bold" id="kpiProdutos">0</div></div></div>
        </div>
        <div class="mt-3 card p-3" style="height:260px;"><canvas id="chartMes"></canvas></div>
      </div>

      <!-- VENDAS (MANTIVE E ADAPTEI) -->
      <div id="vendasCard" class="card p-3">
        <h5>Vendas</h5>
        <div class="row">
          <div class="col-md-6 border-end">
            <div class="mb-2"><input id="buscaVenda" class="form-control" placeholder="Buscar produto..." oninput="filtrarSelectProdutos()"></div>
            <div class="mb-2"><input id="scanBarras" class="form-control" placeholder="Passe o leitor de código e tecle Enter" onkeydown="buscarPorBarrasVendas(event)"></div>
            <div class="mb-2"><select id="selectProduto" class="form-select"></select></div>
            <div class="mb-2 d-flex gap-2">
              <input id="quantidadeVenda" type="number" value="1" min="1" class="form-control">
              <button class="btn btn-primary" onclick="adicionarCarrinho()"><i class="bi bi-plus-circle"></i></button>
            </div>
            <div class="mb-2">
              <label>Cliente (opcional)</label>
              <select id="selectCliente" class="form-select">
                <option value="">Não vincular</option>
              </select>
            </div>
            <div class="d-grid">
              <button class="btn btn-success btn-lg" onclick="finalizarVenda()"><i class="bi bi-check2-circle"></i> Finalizar Venda</button>
            </div>
          </div>

          <div class="col-md-6">
            <ul id="listaCarrinho" class="list-group mb-2"></ul>
            <div class="fw-bold">Total: <span id="total">R$ 0,00</span></div>
            <div class="card mt-3 p-3">
              <label>Forma de pagamento</label>
              <select id="formaPagamento" class="form-select mb-2" onchange="toggleTroco()">
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">PIX</option>
                <option value="cartao">Cartão</option>
              </select>
              <div id="pagamentoDinheiro">
                <label>Valor pago</label>
                <input id="valorPago" type="number" step="0.01" class="form-control" oninput="calcularTroco()">
                <div>Troco: <span id="troco">R$ 0,00</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRODUTOS -->
      <div id="produtosCard" class="card p-3">
        <h5>Cadastro de Produtos</h5>
        <div class="row g-2">
          <div class="col-md-4"><input id="nomeProduto" class="form-control" placeholder="Nome"></div>
          <div class="col-md-4"><input id="descricaoProduto" class="form-control" placeholder="Descrição"></div>
          <div class="col-md-4"><input id="codigoProduto" class="form-control" placeholder="Código de Barras"></div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-md-3"><input id="precoProduto" type="number" step="0.01" class="form-control" placeholder="Preço"></div>
          <div class="col-md-3"><input id="estoqueProduto" type="number" class="form-control" placeholder="Estoque"></div>
          <div class="col-md-6 d-grid"><button class="btn btn-success" onclick="salvarProduto()"><i class="bi bi-save"></i> Salvar</button></div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6"><input id="buscaProduto" class="form-control" placeholder="Buscar por nome/descrição/código..." oninput="filtrarTabelaProdutos()"></div>
        </div>
        <table class="table mt-3">
          <thead><tr><th>Código</th><th>Nome</th><th>Descrição</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
          <tbody id="tProdutos"></tbody>
        </table>
      </div>

      <!-- CLIENTES -->
      <div id="clientesCard" class="card p-3">
        <div class="d-flex align-items-center justify-content-between">
          <h5><i class="bi bi-people"></i> Clientes</h5>
          <button class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#novoCliente"><i class="bi bi-person-plus"></i> Novo</button>
        </div>

        <div id="novoCliente" class="collapse mt-2">
          <div class="card p-3">
            <div class="row g-2">
              <div class="col-md-4"><input id="cliNome" class="form-control" placeholder="Nome completo"></div>
              <div class="col-md-3"><input id="cliTelefone" class="form-control" placeholder="Telefone (somente números)"></div>
              <div class="col-md-3"><input id="cliCpf" class="form-control" placeholder="CPF/CNPJ"></div>
              <div class="col-md-2 d-grid"><button class="btn btn-success" onclick="salvarCliente()"><i class="bi bi-save"></i> Salvar</button></div>
              <div class="col-12 mt-2"><input id="cliEmail" class="form-control" placeholder="E-mail (opcional)"></div>
              <div class="col-12 mt-2"><textarea id="cliObs" class="form-control" rows="2" placeholder="Observações"></textarea></div>
            </div>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>Nome</th><th>Telefone</th><th>CPF/CNPJ</th><th>E-mail</th><th>Compras</th><th>Ações</th></tr></thead>
            <tbody id="tbClientes"></tbody>
          </table>
        </div>
      </div>

      <!-- RELATÓRIOS -->
      <div id="relatoriosCard" class="card p-3">
        <h5><i class="bi bi-graph-up-arrow"></i> Relatórios</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3" style="height:300px;"><div class="fw-semibold mb-2">Faturamento últimos 12 meses</div><canvas id="chartFatMes"></canvas></div>
          </div>
          <div class="col-md-6">
            <div class="card p-3" style="height:300px;"><div class="fw-semibold mb-2">Top Produtos (Qtd)</div><canvas id="chartTopProdutos"></canvas></div>
          </div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-outline-secondary" onclick="window.print()"><i class="bi bi-printer"></i> Imprimir/Salvar PDF</button>
          <button class="btn btn-outline-primary" onclick="exportarRelatorioCSV()"><i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV</button>
        </div>
      </div>

      <!-- HISTÓRICO -->
      <div id="historico" class="card p-3">
        <h5><i class="bi bi-receipt"></i> Histórico de Vendas</h5>
        <div id="listaHistorico" class="mt-2"></div>
      </div>

      <!-- CAIXA -->
      <div id="caixaCard" class="card p-3">
        <h5><i class="bi bi-cash-coin"></i> Caixa</h5>
        <div class="mb-2">Saldo atual: <strong id="saldoCaixa">R$ 0,00</strong></div>
        <ul id="listaCaixa" class="list-group"></ul>
      </div>

      <!-- COMPROVANTE -->
      <div id="comprovante" class="card p-3">
        <h5><i class="bi bi-printer"></i> Cupom</h5>
        <div id="cupom">Selecione uma venda no histórico para ver o cupom aqui.</div>
        <div class="mt-3 row g-2">
          <div class="col-md-4"><input id="wppTelefone" class="form-control" placeholder="WhatsApp com DDD (ex: 93999999999)"></div>
          <div class="col-md-3 d-grid"><button class="btn btn-success" onclick="enviarWhatsApp()"><i class="bi bi-whatsapp"></i> Enviar Cupom</button></div>
          <div class="col-md-3 d-grid"><button class="btn btn-outline-primary" onclick="window.print()"><i class="bi bi-printer"></i> Imprimir</button></div>
        </div>
      </div>

      <!-- CONFIG -->
      <div id="configCard" class="card p-3">
        <h5><i class="bi bi-gear"></i> Configurações</h5>
        <div class="mb-2 fw-semibold">Backup</div>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary" onclick="exportarBackup()"><i class="bi bi-cloud-download"></i> Exportar Backup</button>
          <label class="btn btn-outline-success mb-0">
            <i class="bi bi-cloud-upload"></i> Importar Backup
            <input type="file" accept="application/json" hidden onchange="importarBackup(event)">
          </label>
        </div>
        <hr>
        <div class="mb-2 fw-semibold">App Instalável (PWA)</div>
        <p class="small text-muted">Abra via servidor (http://localhost) para testar o PWA. No Chrome/Edge aparecerá opção "Instalar".</p>
      </div>

    </div>
  </main>

  <!-- FAB -->
  <button class="btn btn-primary fab" onclick="toggleCard('vendasCard',this)"><i class="bi bi-plus-lg"></i></button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ----------------- Utilidades ----------------- */
function money(v){ return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function getLS(k,def){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); }catch(e){ return def; } }
function setLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ----------------- Estado (carrega do localStorage) ----------------- */
let produtos = getLS('pdv_produtos', []);            // [{id,nome,descricao,codigo,preco,estoque}]
let historico = getLS('pdv_hist', []);               // [{id,data,itens:[{id,nome,preco,qtd}],total,clienteId,clienteNome,forma}]
let caixa = getLS('pdv_caixa', { saldo:0, movs: [] });
let clientes = getLS('pdv_clientes', []);            // [{id,nome,telefone,cpf,email,obs,compras}]

/* Garantias */
clientes.forEach(c=>{ if(typeof c.compras!=='number') c.compras = 0; });
setLS('pdv_clientes', clientes);

/* ----------------- Navegação (toggleCard) ----------------- */
function toggleCard(id, el) {
  // Esconde todos os cards
  ['dashboardCard','vendasCard','produtosCard','clientesCard','relatoriosCard','historico','caixaCard','comprovante','configCard']
    .forEach(cid => { const e = document.getElementById(cid); if(e) e.style.display = 'none'; });
  // Mostra selecionado
  const target = document.getElementById(id);
  if(target) target.style.display = 'block';
  // Ativa item do menu
  document.querySelectorAll('.menu a, .offcanvas-body a').forEach(a=>a.classList.remove('active'));
  if(el && el.classList) el.classList.add('active');
  // Fechar offcanvas no mobile se estiver aberto
  try {
    const off = document.getElementById('menuMobile');
    const bs = bootstrap.Offcanvas.getInstance(off);
    if(bs) bs.hide();
  } catch(e){}
  // Atualizar gráficos/visões quando abrir certas telas
  if(id === 'produtosCard') renderProdutos();
  if(id === 'clientesCard') listarClientes();
  if(id === 'relatoriosCard') buildRelatorios();
  if(id === 'historico') renderHistorico();
  if(id === 'caixaCard') renderCaixa();
}

/* ----------------- Produtos ----------------- */
let editingIndex = null;
function salvarProduto(){
  const nome = document.getElementById('nomeProduto').value.trim();
  const desc = document.getElementById('descricaoProduto').value.trim();
  const codigo = document.getElementById('codigoProduto').value.trim();
  const preco = parseFloat(document.getElementById('precoProduto').value);
  const est = parseInt(document.getElementById('estoqueProduto').value);
  if(!nome || isNaN(preco) || isNaN(est)){ alert('Preencha nome, preço e estoque'); return; }
  // prevenir duplicados por codigo
  if(codigo){
    const dup = produtos.find((p,ix)=>p.codigo===codigo && ix!==editingIndex);
    if(dup) return alert('Já existe produto com esse código');
  }
  if(editingIndex === null){
    produtos.push({ id: Date.now(), nome, descricao: desc, codigo, preco, estoque: est });
  } else {
    const p = produtos[editingIndex];
    p.nome = nome; p.descricao = desc; p.codigo = codigo; p.preco = preco; p.estoque = est;
    editingIndex = null;
  }
  setLS('pdv_produtos', produtos);
  renderProdutos();
  ['nomeProduto','descricaoProduto','codigoProduto','precoProduto','estoqueProduto'].forEach(i=>document.getElementById(i).value='');
  alert('Produto salvo!');
}
function editarProduto(i){
  editingIndex = i;
  const p = produtos[i];
  document.getElementById('nomeProduto').value = p.nome || '';
  document.getElementById('descricaoProduto').value = p.descricao || '';
  document.getElementById('codigoProduto').value = p.codigo || '';
  document.getElementById('precoProduto').value = p.preco || '';
  document.getElementById('estoqueProduto').value = p.estoque || '';
  toggleCard('produtosCard');
}
function deletarProduto(i){
  if(!confirm('Excluir produto?')) return;
  produtos.splice(i,1);
  setLS('pdv_produtos', produtos);
  renderProdutos();
}
function renderProdutos(){
  const tbody = document.getElementById('tProdutos');
  tbody.innerHTML = '';
  produtos.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.codigo||''}</td><td>${p.nome}</td><td>${p.descricao||''}</td><td>${money(p.preco)}</td><td>${p.estoque}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editarProduto(${i})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-danger" onclick="deletarProduto(${i})"><i class="bi bi-trash"></i></button>
      </td>`;
    tbody.appendChild(tr);
  });
  // preencher select de vendas
  const termo = (document.getElementById('buscaVenda')?.value||'').toLowerCase();
  const sel = document.getElementById('selectProduto'); sel.innerHTML = '';
  produtos.filter(p => {
    const alvo = `${p.nome} ${p.descricao||''} ${p.codigo||''}`.toLowerCase();
    return !termo || alvo.includes(termo);
  }).forEach(p => sel.innerHTML += `<option value="${p.id}">${p.nome} - ${money(p.preco)} (${p.estoque})</option>`);
}

/* Filtro tabela produtos */
function filtrarTabelaProdutos(){
  const termo = (document.getElementById('buscaProduto')?.value||'').toLowerCase();
  document.querySelectorAll('#tProdutos tr').forEach(tr=>{
    const txt = tr.textContent.toLowerCase();
    tr.style.display = termo && !txt.includes(termo) ? 'none' : '';
  });
}

/* ----------------- Clientes ----------------- */
function salvarCliente(){
  const nome = document.getElementById('cliNome').value.trim();
  const telefone = document.getElementById('cliTelefone').value.trim();
  const cpf = document.getElementById('cliCpf').value.trim();
  const email = document.getElementById('cliEmail').value.trim();
  const obs = document.getElementById('cliObs').value.trim();
  if(!nome){ alert('Informe o nome.'); return; }
  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
  clientes.push({ id, nome, telefone, cpf, email, obs, compras: 0 });
  setLS('pdv_clientes', clientes);
  listarClientes();
  // reset form
  ['cliNome','cliTelefone','cliCpf','cliEmail','cliObs'].forEach(i=>document.getElementById(i).value='');
  // atualizar select de clientes em Vendas
  preencherSelectClientes();
  alert('Cliente salvo!');
}
function removerCliente(id){
  if(!confirm('Remover cliente?')) return;
  clientes = clientes.filter(c=>c.id !== id);
  setLS('pdv_clientes', clientes);
  listarClientes();
  preencherSelectClientes();
}
function listarClientes(){
  const tb = document.getElementById('tbClientes');
  tb.innerHTML = '';
  clientes.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.nome}</td><td>${c.telefone||'-'}</td><td>${c.cpf||'-'}</td><td>${c.email||'-'}</td><td>${c.compras||0}</td>
      <td class="text-nowrap">
        <button class="btn btn-sm btn-outline-primary me-1" onclick="verHistoricoCliente('${c.id}')"><i class="bi bi-clock-history"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="removerCliente('${c.id}')"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(tr);
  });
}
function preencherSelectClientes(){
  const sel = document.getElementById('selectCliente');
  sel.innerHTML = `<option value="">Não vincular</option>`;
  clientes.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.nome} ${c.telefone?('- '+c.telefone):''}</option>`);
}
function verHistoricoCliente(id){
  const c = clientes.find(x=>x.id===id);
  if(!c){ alert('Cliente não encontrado'); return; }
  toggleCard('historico');
  const vendasCli = historico.filter(h=>h.clienteId === id);
  let html = `<div class="fw-semibold mb-2">Histórico de ${c.nome}</div>`;
  if(vendasCli.length===0) html += '<div class="text-muted">Sem vendas vinculadas.</div>';
  else vendasCli.forEach(h=>{
    const data = new Date(h.data||Date.now()).toLocaleString('pt-BR');
    html += `<div class="border rounded p-2 mb-2"><div><b>${h.id||'-'}</b> — ${data} — <b>Total:</b> ${money(h.total||0)}</div>
      <div class="small text-muted">${(h.itens||[]).map(i=>`${i.nome} x${i.qtd}`).join(', ')}</div></div>`;
  });
  document.getElementById('listaHistorico').innerHTML = html;
}

/* ----------------- Carrinho e Vendas ----------------- */
let carrinho = [], total = 0;
function adicionarCarrinho(){
  const sel = document.getElementById('selectProduto');
  const idSel = sel && sel.value ? Number(sel.value) : null;
  const qtd = parseInt(document.getElementById('quantidadeVenda').value) || 1;
  const p = produtos.find(x=>x.id===idSel);
  if(!p) return alert('Selecione um produto');
  if(qtd<=0) return;
  if(p.estoque < qtd) return alert('Estoque insuficiente');
  let ex = carrinho.find(c=>c.id===p.id);
  if(ex){ if(ex.qtd + qtd > p.estoque) return alert('Estoque insuficiente'); ex.qtd += qtd; }
  else carrinho.push({ id: p.id, nome: p.nome, preco: p.preco, qtd });
  renderCarrinho();
}
function renderCarrinho(){
  const ul = document.getElementById('listaCarrinho');
  ul.innerHTML = '';
  total = 0;
  carrinho.forEach((c,i)=>{
    total += c.preco * c.qtd;
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `${c.nome} x ${c.qtd} - ${money(c.preco)} <button class="btn btn-sm btn-danger" onclick="removerCarrinho(${i})">x</button>`;
    ul.appendChild(li);
  });
  document.getElementById('total').textContent = money(total);
  calcularTroco();
}
function removerCarrinho(i){ carrinho.splice(i,1); renderCarrinho(); }

function buscarPorBarrasVendas(e){
  if(e.key === 'Enter'){
    const codigo = e.target.value.trim();
    if(!codigo) return;
    adicionarPorCodigo(codigo);
    e.target.value = '';
  }
}
function adicionarPorCodigo(codigo, qtd = 1){
  const p = produtos.find(x => (x.codigo||'') === codigo);
  if(!p) return alert('Produto não encontrado pelo código');
  if(p.estoque < qtd) return alert('Estoque insuficiente');
  let ex = carrinho.find(c=>c.id===p.id);
  if(ex){ if(ex.qtd + qtd > p.estoque) return alert('Estoque insuficiente'); ex.qtd += qtd; } 
  else carrinho.push({ id: p.id, nome: p.nome, preco: p.preco, qtd });
  renderCarrinho();
}

function toggleTroco(){
  const isDin = document.getElementById('formaPagamento').value === 'dinheiro';
  document.getElementById('pagamentoDinheiro').style.display = isDin ? 'block' : 'none';
  calcularTroco();
}
function calcularTroco(){
  if(document.getElementById('formaPagamento').value !== 'dinheiro'){
    document.getElementById('troco').textContent = money(0); return;
  }
  const pago = parseFloat(document.getElementById('valorPago').value) || 0;
  const troco = Math.max(0, pago - total);
  document.getElementById('troco').textContent = money(troco);
}

function finalizarVenda(){
  if(carrinho.length === 0) return alert('Carrinho vazio');
  const forma = document.getElementById('formaPagamento').value;
  let pago = total, troco = 0;
  if(forma === 'dinheiro'){
    pago = parseFloat(document.getElementById('valorPago').value);
    if(isNaN(pago) || pago < total) return alert('Valor pago insuficiente');
    troco = pago - total;
    caixa.saldo += total;
    caixa.movs.unshift({ id: Date.now(), tipo: 'entrada', valor: total, desc: 'Venda balcão', data: new Date().toISOString() });
    setLS('pdv_caixa', caixa);
  }
  // baixa estoque
  carrinho.forEach(it => {
    const p = produtos.find(x => x.id === it.id);
    if(p) p.estoque -= it.qtd;
  });
  setLS('pdv_produtos', produtos);
  // montar venda
  const clienteId = document.getElementById('selectCliente').value || null;
  const clienteObj = clientes.find(c=>c.id === clienteId);
  const venda = {
    id: Date.now(),
    data: new Date().toISOString(),
    itens: JSON.parse(JSON.stringify(carrinho)),
    total,
    pago,
    troco,
    forma,
    clienteId,
    clienteNome: clienteObj ? clienteObj.nome : null
  };
  historico.unshift(venda);
  setLS('pdv_hist', historico);
  // incrementar contador de compras do cliente
  if(clienteObj){
    clienteObj.compras = (clienteObj.compras || 0) + 1;
    setLS('pdv_clientes', clientes);
    listarClientes();
  }
  // registrar caixa
  setLS('pdv_caixa', caixa);
  // gerar cupom e limpar
  verCupom(venda);
  carrinho = []; renderCarrinho(); renderProdutos(); buildRelatorios(); renderHistorico();
  toggleCard('comprovante');
  alert('Venda registrada!');
}

/* ----------------- CUPOM / WHATSAPP ----------------- */
let ultimoCupomTexto = '';
function gerarTextoCupom(v){
  const data = new Date(v.data||Date.now()).toLocaleString('pt-BR');
  let s = '*** PDV COSMÉTICOS ***\\n';
  s += 'Data: ' + data + '\\n';
  if(v.clienteNome) s += 'Cliente: ' + v.clienteNome + '\\n';
  s += '-----------------------------\\n';
  (v.itens||[]).forEach(i=> s += `${i.nome}  x${i.qtd||1}  ${money(i.preco||0)}\\n`);
  s += '-----------------------------\\n';
  s += 'TOTAL: ' + money(v.total||0) + '\\n';
  s += '\\nObrigado pela preferência!';
  return s;
}
function verCupom(v){
  const txt = gerarTextoCupom(v);
  ultimoCupomTexto = txt;
  document.getElementById('cupom').textContent = txt;
}
function enviarWhatsApp(){
  const tel = (document.getElementById('wppTelefone').value||'').replace(/\\D/g,'');
  if(!tel) return alert('Informe o telefone com DDD.');
  if(!ultimoCupomTexto) return alert('Abra um cupom no Histórico primeiro.');
  const url = 'https://wa.me/55' + tel + '?text=' + encodeURIComponent(ultimoCupomTexto);
  window.open(url, '_blank');
}

/* ----------------- HISTÓRICO ----------------- */
function renderHistorico(){
  const cont = document.getElementById('listaHistorico');
  cont.innerHTML = '';
  if(historico.length === 0){ cont.innerHTML = '<div class="text-muted">Sem vendas registradas.</div>'; return; }
  historico.slice().forEach(h=>{
    const data = new Date(h.data||Date.now()).toLocaleString('pt-BR');
    const div = document.createElement('div');
    div.className = 'border rounded p-2 mb-2 d-flex justify-content-between align-items-center';
    div.innerHTML = `<div>
        <div><b>${h.id}</b> — ${data} — <b>Total:</b> ${money(h.total||0)}</div>
        <div class="small text-muted">${(h.itens||[]).map(i=>`${i.nome} x${i.qtd}`).join(', ')}</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick='verCupom(${JSON.stringify(h)}); toggleCard("comprovante")'><i class="bi bi-ticket-perforated"></i></button>
      </div>`;
    cont.appendChild(div);
  });
}

/* ----------------- CAIXA ----------------- */
function renderCaixa(){
  document.getElementById('saldoCaixa').textContent = money(caixa.saldo || 0);
  const ul = document.getElementById('listaCaixa');
  ul.innerHTML = '';
  (caixa.movs||[]).forEach(m=>{
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between';
    li.innerHTML = `<span>${new Date(m.data).toLocaleString('pt-BR')} — ${m.tipo.toUpperCase()} — ${m.desc||'-'}</span><strong>${money(m.valor)}</strong>`;
    ul.appendChild(li);
  });
}

/* ----------------- RELATÓRIOS ----------------- */
let chartMes, chartFatMes, chartTopProdutos;
function buildRelatorios(){
  // KPI
  const now = new Date();
  const mes = now.getMonth();
  const ano = now.getFullYear();
  const vendasMes = historico.filter(h=>{
    const d = new Date(h.data||Date.now());
    return d.getMonth() === mes && d.getFullYear() === ano;
  });
  const totalMes = vendasMes.reduce((s,h)=>s + (h.total||0), 0);
  document.getElementById('kpiVendasMes').textContent = vendasMes.length;
  document.getElementById('kpiFatMes').textContent = money(totalMes);
  document.getElementById('kpiClientes').textContent = clientes.length;
  document.getElementById('kpiProdutos').textContent = produtos.length;

  // Dashboard últimos 6 meses
  const mapa6 = {};
  for(let i=5;i>=0;i--){
    const d = new Date(ano, mes - i, 1);
    mapa6[d.toLocaleDateString('pt-BR',{month:'short', year:'2-digit'})] = 0;
  }
  historico.forEach(h=>{
    const d = new Date(h.data||Date.now());
    const key = d.toLocaleDateString('pt-BR',{month:'short', year:'2-digit'});
    if(key in mapa6) mapa6[key] += (h.total||0);
  });
  if(chartMes) chartMes.destroy();
  chartMes = new Chart(document.getElementById('chartMes'), { type:'line', data:{ labels:Object.keys(mapa6), datasets:[{ label:'Faturamento', data:Object.values(mapa6) }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } } });

  // Faturamento 12 meses
  const mapa12 = {};
  for(let i=11;i>=0;i--){
    const d = new Date(ano, mes - i, 1);
    mapa12[d.toLocaleDateString('pt-BR',{month:'short', year:'2-digit'})] = 0;
  }
  historico.forEach(h=>{
    const d = new Date(h.data||Date.now());
    const key = d.toLocaleDateString('pt-BR',{month:'short', year:'2-digit'});
    if(key in mapa12) mapa12[key] += (h.total||0);
  });
  if(chartFatMes) chartFatMes.destroy();
  chartFatMes = new Chart(document.getElementById('chartFatMes'), { type:'bar', data:{ labels:Object.keys(mapa12), datasets:[{ label:'Faturamento', data:Object.values(mapa12) }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });

  // Top produtos
  const contagem = {};
  historico.forEach(h => (h.itens||[]).forEach(i => contagem[i.nome] = (contagem[i.nome]||0) + (i.qtd||1)));
  const top = Object.entries(contagem).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(chartTopProdutos) chartTopProdutos.destroy();
  chartTopProdutos = new Chart(document.getElementById('chartTopProdutos'), { type:'bar', data:{ labels: top.map(t=>t[0]), datasets:[{ label:'Quantidade', data: top.map(t=>t[1]) }] }, options:{ indexAxis:'y', responsive:true, scales:{ x:{ beginAtZero:true } } } });
}

/* ----------------- Exportar Relatório CSV ----------------- */
function exportarRelatorioCSV(){
  if(historico.length===0) return alert('Sem vendas para exportar');
  let csv = "Data,Produto,Quantidade,Preço Unitário,Total,Forma,Cliente\n";
  historico.forEach(h=>{
    (h.itens||[]).forEach(i=>{
      csv += `"${new Date(h.data).toLocaleString('pt-BR')}", "${i.nome}", ${i.qtd}, ${i.preco}, ${i.qtd * i.preco}, ${h.forma}, "${h.clienteNome||''}"\n`;
    });
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'relatorio_vendas.csv'; a.click();
}

/* ----------------- BACKUP ----------------- */
function exportarBackup(){
  const dados = { produtos, historico, caixa, clientes };
  const blob = new Blob([JSON.stringify(dados,null,2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'backup_pdv.json';
  a.click();
}
function importarBackup(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const dados = JSON.parse(e.target.result);
      if(dados.produtos) setLS('pdv_produtos', dados.produtos);
      if(dados.historico) setLS('pdv_hist', dados.historico);
      if(dados.caixa) setLS('pdv_caixa', dados.caixa);
      if(dados.clientes) setLS('pdv_clientes', dados.clientes);
      alert('Backup restaurado com sucesso! Recarregando...');
      location.reload();
    } catch(err){ alert('Arquivo inválido de backup.'); }
  };
  reader.readAsText(file);
}

/* ----------------- PWA: registrar service worker ----------------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{/* falha silenciosa */});
  });
}

/* ----------------- Inicialização ----------------- */
function init(){
  toggleCard('dashboardCard');
  renderProdutos();
  listarClientes();
  preencherSelectClientes();
  renderHistorico();
  renderCaixa();
  buildRelatorios();
}
init();

</script>
</body>
</html>
