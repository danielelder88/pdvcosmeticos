<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PDV Cosméticos — Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--roxao:#6f42c1}
    body{background:#f8f9fa}
    .menu{width:260px;min-height:100vh;background:var(--roxao);color:#fff;position:fixed;inset:0 auto 0 0;padding:20px}
    .menu a{display:block;color:#fff;text-decoration:none;padding:10px 12px;margin:6px 0;border-radius:10px}
    .menu a.active,.menu a:hover{background:#55339e}
    .content{margin-left:280px;padding:20px}
    .card{border-radius:14px}
    #comprovante,#historico,#produtosCard,#caixaCard,#vendasCard,#configCard{display:none}
    /* Cupom não fiscal */
    #cupom{font-family:monospace;white-space:pre-wrap;background:#fff;padding:10px;border:1px dashed #ccc;max-width:360px;margin:auto}
    @media print{
      body *{visibility:hidden}
      #cupom,#cupom *{visibility:visible}
      #cupom{position:absolute;left:0;top:0;width:80mm;font-size:12px;line-height:1.3}
    }
  </style>
</head>
<body>
  <!-- MENU -->
  <aside class="menu">
    <h4 class="mb-3"><i class="bi bi-shop"></i> PDV</h4>
    <a onclick="toggleCard('dashboardCard',this)" class="active"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a onclick="toggleCard('vendasCard',this)"><i class="bi bi-cart"></i> Vendas</a>
    <a onclick="toggleCard('produtosCard',this)"><i class="bi bi-box-seam"></i> Produtos</a>
    <a onclick="toggleCard('historico',this)"><i class="bi bi-receipt"></i> Histórico</a>
    <a onclick="toggleCard('caixaCard',this)"><i class="bi bi-cash-coin"></i> Caixa</a>
    <a onclick="toggleCard('comprovante',this)"><i class="bi bi-printer"></i> Comprovante</a>
    <a onclick="toggleCard('configCard',this)"><i class="bi bi-gear"></i> Configurações</a>
  </aside>

  <main class="content">
    <div class="container-fluid">
      <h2 class="mb-3 d-flex align-items-center gap-2">
        <i class="bi bi-cart4"></i> PDV Cosméticos — Completo
        <span class="badge bg-light text-dark">Pro</span>
      </h2>

      <!-- DASHBOARD -->
      <div id="dashboardCard">
        <div class="card p-3 mb-3">
          <div class="row g-2">
            <div class="col-md-3"><input id="fAno" class="form-control" type="number" placeholder="Ano"></div>
            <div class="col-md-3"><input id="fMes" class="form-control" type="number" placeholder="Mês (1-12)"></div>
            <div class="col-md-3"><input id="fDia" class="form-control" type="number" placeholder="Dia"></div>
            <div class="col-md-3 d-grid">
              <button class="btn btn-primary" onclick="aplicarFiltrosDashboard()"><i class="bi bi-funnel"></i> Aplicar filtros</button>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3"><div class="card p-3">Vendas: <strong id="dashVendas">0</strong></div></div>
          <div class="col-md-3"><div class="card p-3">Faturamento: <strong id="dashFaturamento">R$ 0,00</strong></div></div>
          <div class="col-md-3"><div class="card p-3">Itens estoque: <strong id="dashItens">0</strong></div></div>
          <div class="col-md-3"><div class="card p-3">Baixo estoque: <strong id="dashBaixo">0</strong></div></div>
        </div>

        <div class="row g-3">
          <div class="col-md-6"><canvas id="graficoBarras"></canvas></div>
          <div class="col-md-6"><canvas id="graficoPizza"></canvas></div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <button class="btn btn-outline-primary" onclick="imprimirDashboard()"><i class="bi bi-printer"></i> Imprimir Dashboard</button>
        </div>
      </div>

      <!-- VENDAS -->
      <div id="vendasCard" class="card p-3">
        <h5>Vendas</h5>
        <div class="row">
          <div class="col-md-6 border-end">
            <input id="buscaVenda" class="form-control mb-2" placeholder="Buscar por nome/descrição/código..." oninput="filtrarSelectProdutos()">
            <input id="scanBarras" class="form-control mb-2" placeholder="Passe o leitor de código e tecle Enter" onkeydown="buscarPorBarrasVendas(event)">
            <select id="selectProduto" class="form-select mb-2"></select>
            <input id="quantidadeVenda" type="number" value="1" min="1" class="form-control mb-2">
            <button class="btn btn-primary w-100" onclick="adicionarCarrinho()"><i class="bi bi-plus-circle"></i> Adicionar</button>
          </div>
          <div class="col-md-6">
            <ul id="listaCarrinho" class="list-group mb-2"></ul>
            <div class="fw-bold">Total: <span id="total">R$ 0,00</span></div>
            <div class="card mt-3 p-3">
              <label>Forma de pagamento</label>
              <select id="formaPagamento" class="form-select mb-2" onchange="toggleTroco()">
                <option value="dinheiro">Dinheiro</option>
                <option value="pix">PIX</option>
                <option value="cartao">Cartão</option>
              </select>
              <div id="pagamentoDinheiro">
                <label>Valor pago</label>
                <input id="valorPago" type="number" step="0.01" class="form-control">
                <div>Troco: <span id="troco">R$ 0,00</span></div>
              </div>
              <button class="btn btn-success btn-lg w-100 mt-3" onclick="finalizarVenda()">
                <i class="bi bi-check2-circle"></i> Finalizar Venda
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- PRODUTOS -->
      <div id="produtosCard" class="card p-3">
        <h5>Cadastro de Produtos</h5>
        <div class="row g-2">
          <div class="col-md-4"><input id="nomeProduto" class="form-control" placeholder="Nome"></div>
          <div class="col-md-4"><input id="descricaoProduto" class="form-control" placeholder="Descrição"></div>
          <div class="col-md-4"><input id="codigoProduto" class="form-control" placeholder="Código de Barras (escaneie ou digite)"></div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-md-3"><input id="precoProduto" type="number" step="0.01" class="form-control" placeholder="Preço"></div>
          <div class="col-md-3"><input id="estoqueProduto" type="number" class="form-control" placeholder="Estoque"></div>
          <div class="col-md-6 d-grid"><button class="btn btn-success" onclick="salvarProduto()"><i class="bi bi-save"></i> Salvar</button></div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6"><input id="buscaProduto" class="form-control" placeholder="Buscar por nome/descrição/código..." oninput="filtrarTabelaProdutos()"></div>
        </div>
        <table class="table mt-3">
          <thead><tr><th>Código</th><th>Nome</th><th>Descrição</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
          <tbody id="tProdutos"></tbody>
        </table>
      </div>

      <!-- HISTÓRICO -->
      <div id="historico" class="card p-3">
        <h5>Histórico de Vendas</h5>
        <div class="row g-2 mb-2">
          <div class="col-md-3"><input id="hAno" class="form-control" type="number" placeholder="Ano"></div>
          <div class="col-md-3"><input id="hMes" class="form-control" type="number" placeholder="Mês (1-12)"></div>
          <div class="col-md-3"><input id="hDia" class="form-control" type="number" placeholder="Dia"></div>
          <div class="col-md-3 d-grid"><button class="btn btn-primary" onclick="aplicarFiltrosHistorico()"><i class="bi bi-funnel"></i> Filtrar</button></div>
        </div>
        <div class="mb-2 d-flex gap-2">
          <button class="btn btn-outline-success" onclick="exportarCSV()"><i class="bi bi-file-earmark-excel"></i> Exportar CSV</button>
          <button class="btn btn-outline-primary" onclick="imprimirRelatorio()"><i class="bi bi-printer"></i> Imprimir Relatório</button>
        </div>
        <ul id="tHistorico" class="list-group"></ul>
      </div>

      <!-- CAIXA -->
      <div id="caixaCard" class="card p-3">
        <h5>Caixa</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <select id="tipoMov" class="form-select">
              <option value="entrada">Entrada</option>
              <option value="saida">Saída</option>
            </select>
          </div>
          <div class="col-md-4"><input id="valorMov" type="number" step="0.01" class="form-control" placeholder="Valor"></div>
          <div class="col-md-4"><input id="descMov" class="form-control" placeholder="Descrição"></div>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-success" onclick="registrarMovimento()"><i class="bi bi-plus-circle"></i> Registrar</button>
          <button class="btn btn-outline-primary" onclick="imprimirCaixa()"><i class="bi bi-printer"></i> Imprimir Caixa</button>
        </div>
        <div class="mt-3">Saldo atual: <strong id="saldoCaixa">R$ 0,00</strong></div>
        <ul id="listaCaixa" class="list-group mt-2"></ul>
      </div>

      <!-- COMPROVANTE -->
      <div id="comprovante" class="card p-3">
        <h5>Comprovante</h5>
        <div id="cupom"></div>
        <div class="mt-2 d-flex gap-2 justify-content-center">
          <button class="btn btn-success" onclick="window.print()"><i class="bi bi-printer"></i> Imprimir</button>
          <button class="btn btn-outline-secondary" onclick="toggleCard('vendasCard',document.querySelector('.menu a:nth-child(3)'))">Voltar às Vendas</button>
        </div>
      </div>

      <!-- CONFIG -->
      <div id="configCard" class="card p-3">
        <h5>Configurações da Loja</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label>Nome da Loja</label>
            <input id="configNome" class="form-control" placeholder="Ex: Minha Loja">
          </div>
          <div class="col-md-6">
            <label>CNPJ</label>
            <input id="configCnpj" class="form-control" placeholder="00.000.000/0001-00">
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-success" onclick="salvarConfig()"><i class="bi bi-save"></i> Salvar Configurações</button>
        </div>
      </div>

    </div>
  </main>

<script>
/* ========= ESTADO & UTIL ========= */
const KEY_PROD='pdv_produtos', KEY_HIST='pdv_hist', KEY_CAIXA='pdv_caixa', KEY_CONF_NOME='pdv_nome', KEY_CONF_CNPJ='pdv_cnpj';
let produtos=JSON.parse(localStorage.getItem(KEY_PROD)||'[]');
let historico=JSON.parse(localStorage.getItem(KEY_HIST)||'[]');
let caixa=JSON.parse(localStorage.getItem(KEY_CAIXA)||'{"saldo":0,"movs":[]}');
if(!caixa.saldo) caixa.saldo=0; if(!caixa.movs) caixa.movs=[];
let carrinho=[], total=0, editingIndex=null;

const BRL=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

let EMPRESA_NOME = localStorage.getItem(KEY_CONF_NOME) || "DRICCA COSMÉTICOS";
let EMPRESA_CNPJ = localStorage.getItem(KEY_CONF_CNPJ) || "00.000.000/0001-00";
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('configNome').value=EMPRESA_NOME;
  document.getElementById('configCnpj').value=EMPRESA_CNPJ;
});

/* ========= NAVEGAÇÃO ========= */
function toggleCard(id,el){
  ['dashboardCard','vendasCard','produtosCard','historico','caixaCard','comprovante','configCard'].forEach(c=>{
    const e=document.getElementById(c); if(e) e.style.display='none';
  });
  document.querySelectorAll('.menu a').forEach(a=>a.classList.remove('active'));
  if(el) el.classList.add('active');
  const card=document.getElementById(id); if(card) card.style.display='block';
  if(id==='vendasCard'){ setTimeout(()=>document.getElementById('scanBarras')?.focus(),80); }
}

/* ========= CONFIG ========= */
function salvarConfig(){
  EMPRESA_NOME=document.getElementById('configNome').value||EMPRESA_NOME;
  EMPRESA_CNPJ=document.getElementById('configCnpj').value||EMPRESA_CNPJ;
  localStorage.setItem(KEY_CONF_NOME,EMPRESA_NOME);
  localStorage.setItem(KEY_CONF_CNPJ,EMPRESA_CNPJ);
  alert('Configurações salvas!');
}

/* ========= PRODUTOS ========= */
function salvarProduto(){
  const nome=document.getElementById('nomeProduto').value.trim();
  const desc=document.getElementById('descricaoProduto').value.trim();
  const codigo=document.getElementById('codigoProduto').value.trim();
  const preco=parseFloat(document.getElementById('precoProduto').value);
  const est=parseInt(document.getElementById('estoqueProduto').value);
  if(!nome||isNaN(preco)||isNaN(est)) return alert('Preencha nome, preço e estoque');

  // prevenir código duplicado
  if(codigo){
    const dup=produtos.find((p,ix)=>p.codigo===codigo && ix!==editingIndex);
    if(dup) return alert('Já existe produto com esse código de barras');
  }

  if(editingIndex===null){
    produtos.push({id:Date.now(),codigo,nome,descricao:desc,preco,estoque:est});
  }else{
    let p=produtos[editingIndex];
    p.codigo=codigo; p.nome=nome; p.descricao=desc; p.preco=preco; p.estoque=est;
    editingIndex=null;
  }
  localStorage.setItem(KEY_PROD,JSON.stringify(produtos));
  renderProdutos();
  ['nomeProduto','descricaoProduto','codigoProduto','precoProduto','estoqueProduto'].forEach(id=>document.getElementById(id).value='');
}
function editarProduto(i){
  let p=produtos[i]; editingIndex=i;
  document.getElementById('nomeProduto').value=p.nome||'';
  document.getElementById('descricaoProduto').value=p.descricao||'';
  document.getElementById('codigoProduto').value=p.codigo||'';
  document.getElementById('precoProduto').value=p.preco||'';
  document.getElementById('estoqueProduto').value=p.estoque||'';
}
function deletarProduto(i){
  if(!confirm('Excluir produto?')) return;
  produtos.splice(i,1);
  localStorage.setItem(KEY_PROD,JSON.stringify(produtos));
  renderProdutos();
}
function renderProdutos(){
  const tbody=document.getElementById('tProdutos'); if(tbody) tbody.innerHTML='';
  produtos.forEach((p,i)=>{
    if(!tbody) return;
    tbody.innerHTML+=`
      <tr>
        <td>${p.codigo||''}</td>
        <td>${p.nome}</td>
        <td>${p.descricao||''}</td>
        <td>${BRL(p.preco)}</td>
        <td>${p.estoque}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editarProduto(${i})"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-danger" onclick="deletarProduto(${i})"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`;
  });

  // preencher select vendas com filtro
  const termo=(document.getElementById('buscaVenda')?.value||'').toLowerCase();
  let sel=document.getElementById('selectProduto'); if(sel){
    sel.innerHTML='';
    produtos
      .filter(p=>{
        const alvo=`${p.nome} ${p.descricao||''} ${p.codigo||''}`.toLowerCase();
        return !termo || alvo.includes(termo);
      })
      .forEach((p,idx)=>{
        sel.innerHTML+=`<option value="${p.id}">${p.nome} - ${BRL(p.preco)} (${p.estoque})</option>`;
      });
  }

  // dashboard contadores
  const dashItens=document.getElementById('dashItens');
  const dashBaixo=document.getElementById('dashBaixo');
  if(dashItens) dashItens.textContent=produtos.reduce((s,p)=>s+p.estoque,0);
  if(dashBaixo) dashBaixo.textContent=produtos.filter(p=>p.estoque<=3).length;

  filtrarTabelaProdutos(); // aplica filtro visual da tabela (cadastro)
}
function filtrarTabelaProdutos(){
  const termo=(document.getElementById('buscaProduto')?.value||'').toLowerCase();
  document.querySelectorAll('#tProdutos tr').forEach(tr=>{
    const txt=tr.textContent.toLowerCase();
    tr.style.display=termo && !txt.includes(termo) ? 'none' : '';
  });
}
function filtrarSelectProdutos(){ renderProdutos(); }

/* ========= VENDAS ========= */
function adicionarCarrinho(){
  const sel=document.getElementById('selectProduto');
  const idSel = sel && sel.value ? Number(sel.value) : null;
  const qtd=parseInt(document.getElementById('quantidadeVenda').value)||1;

  const p = produtos.find(x=>x.id===idSel);
  if(!p) return alert('Selecione um produto');
  if(qtd<=0) return;
  if(p.estoque<qtd) return alert('Estoque insuficiente');

  let ex=carrinho.find(c=>c.id===p.id);
  if(ex){
    if(ex.qtd+qtd>p.estoque) return alert('Estoque insuficiente');
    ex.qtd+=qtd;
  }else{
    carrinho.push({id:p.id,nome:p.nome,preco:p.preco,qtd});
  }
  renderCarrinho();
}
function renderCarrinho(){
  let ul=document.getElementById('listaCarrinho'); if(!ul) return;
  ul.innerHTML=''; total=0;
  carrinho.forEach((c,i)=>{
    total+=c.preco*c.qtd;
    ul.innerHTML+=`
      <li class="list-group-item d-flex justify-content-between align-items-center">
        ${c.nome} x ${c.qtd} - ${BRL(c.preco)}
        <button class="btn btn-sm btn-danger" onclick="removerCarrinho(${i})">x</button>
      </li>`;
  });
  document.getElementById('total').textContent=BRL(total);
  calcularTroco();
}
function removerCarrinho(i){ carrinho.splice(i,1); renderCarrinho(); }

function buscarPorBarrasVendas(e){
  if(e.key==='Enter'){
    const codigo=e.target.value.trim();
    if(!codigo) return;
    adicionarPorCodigo(codigo);
    e.target.value='';
  }
}
function adicionarPorCodigo(codigo,qtd=1){
  const p=produtos.find(x => (x.codigo||'')===codigo);
  if(!p) return alert('Produto não encontrado pelo código');
  if(p.estoque<qtd) return alert('Estoque insuficiente');

  let ex=carrinho.find(c=>c.id===p.id);
  if(ex){
    if(ex.qtd+qtd>p.estoque) return alert('Estoque insuficiente');
    ex.qtd+=qtd;
  }else{
    carrinho.push({id:p.id,nome:p.nome,preco:p.preco,qtd});
  }
  renderCarrinho();
}

function toggleTroco(){
  let isDin=document.getElementById('formaPagamento').value==='dinheiro';
  document.getElementById('pagamentoDinheiro').style.display=isDin?'block':'none';
  calcularTroco();
}
function calcularTroco(){
  if(document.getElementById('formaPagamento').value!=='dinheiro'){
    document.getElementById('troco').textContent=BRL(0); return;
  }
  const pago=parseFloat(document.getElementById('valorPago').value)||0;
  const troco=Math.max(0,pago-total);
  document.getElementById('troco').textContent=BRL(troco);
}

function finalizarVenda(){
  if(carrinho.length===0) return alert('Carrinho vazio');

  const forma=document.getElementById('formaPagamento').value;
  let pago=total, troco=0;
  if(forma==='dinheiro'){
    pago=parseFloat(document.getElementById('valorPago').value);
    if(isNaN(pago)||pago<total) return alert('Valor pago insuficiente');
    troco=pago-total;
    // registra entrada no caixa
    caixa.saldo+=total;
    caixa.movs.unshift({id:Date.now(),tipo:'entrada',valor:total,desc:'Venda balcão',data:new Date().toISOString()});
    localStorage.setItem(KEY_CAIXA,JSON.stringify(caixa));
    renderCaixa();
  }

  // baixa estoque
  carrinho.forEach(it=>{ const p=produtos.find(x=>x.id===it.id); if(p) p.estoque-=it.qtd; });
  localStorage.setItem(KEY_PROD,JSON.stringify(produtos));
  renderProdutos();

  const venda={id:Date.now(),itens:[...carrinho],total,pago,troco,forma,data:new Date().toISOString()};
  historico.unshift(venda);
  localStorage.setItem(KEY_HIST,JSON.stringify(historico));
  renderHistorico();
  gerarCupom(venda);

  // limpa carrinho e vai ao comprovante
  carrinho=[]; renderCarrinho();
  toggleCard('comprovante',document.querySelector('.menu a[onclick*="comprovante"]'));
}

/* ========= CUPOM ========= */
function gerarCupom(v){
  const c=document.getElementById('cupom');
  let line='------------------------------';
  let txt=`${EMPRESA_NOME}\nCNPJ: ${EMPRESA_CNPJ}\n${line}\n`;
  v.itens.forEach(it=>{
    txt+=`${it.nome}\n ${it.qtd} x ${BRL(it.preco)} = ${BRL(it.preco*it.qtd)}\n`;
  });
  txt+=`${line}\nTOTAL: ${BRL(v.total)}\nPAGO: ${BRL(v.pago)}\nTROCO: ${BRL(v.troco)}\nFORMA: ${v.forma.toUpperCase()}\n${line}\n${new Date(v.data).toLocaleString('pt-BR')}\nObrigado pela preferência!`;
  c.textContent=txt;
}

/* ========= HISTÓRICO ========= */
function aplicarFiltrosHistorico(){ renderHistorico(); }
function renderHistorico(){
  const ul=document.getElementById('tHistorico'); if(!ul) return;
  const ano=document.getElementById('hAno').value; const mes=document.getElementById('hMes').value; const dia=document.getElementById('hDia').value;
  const filtrados = historico.filter(h=>{
    const d=new Date(h.data);
    if(ano && d.getFullYear()!=ano) return false;
    if(mes && (d.getMonth()+1)!=mes) return false;
    if(dia && d.getDate()!=dia) return false;
    return true;
  });

  ul.innerHTML='';
  filtrados.forEach(h=>{
    ul.innerHTML+=`<li class="list-group-item">
      <b>${new Date(h.data).toLocaleString('pt-BR')}</b> — ${h.itens.length} itens — Total: ${BRL(h.total)} — ${h.forma.toUpperCase()}
    </li>`;
  });

  atualizarDashboard(); // reflete nos gráficos
}

function exportarCSV(){
  if(historico.length===0) return alert('Sem vendas para exportar');
  let csv="Data,Produto,Quantidade,Preço Unitário,Total,Forma de Pagamento\n";
  historico.forEach(h=>{
    h.itens.forEach(i=>{
      csv+=`${new Date(h.data).toLocaleString('pt-BR')},${i.nome},${i.qtd},${i.preco},${i.qtd*i.preco},${h.forma}\n`;
    });
  });
  let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  let a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='relatorio_vendas.csv'; a.click();
}

function imprimirRelatorio(){
  const ano=document.getElementById('hAno').value; const mes=document.getElementById('hMes').value; const dia=document.getElementById('hDia').value;
  const filtrados = historico.filter(h=>{
    const d=new Date(h.data);
    if(ano && d.getFullYear()!=ano) return false;
    if(mes && (d.getMonth()+1)!=mes) return false;
    if(dia && d.getDate()!=dia) return false;
    return true;
  });

  if(filtrados.length===0) return alert('Nenhuma venda para imprimir');
  let rel=`${EMPRESA_NOME}\nCNPJ: ${EMPRESA_CNPJ}\nRELATÓRIO DE VENDAS\n===========================\n`;
  filtrados.forEach(h=>{
    rel+=`Data: ${new Date(h.data).toLocaleString('pt-BR')} | Forma: ${h.forma} | Total: ${BRL(h.total)}\n`;
    h.itens.forEach(i=>{ rel+=`  - ${i.nome} (${i.qtd} x ${BRL(i.preco)})\n`; });
    rel+=`---------------------------\n`;
  });
  const w=window.open('','Relatorio'); w.document.write(`<pre>${rel}</pre>`); w.print(); w.close();
}

/* ========= DASHBOARD ========= */
function aplicarFiltrosDashboard(){ atualizarDashboard(); }
function atualizarDashboard(){
  const ano=document.getElementById('fAno').value; const mes=document.getElementById('fMes').value; const dia=document.getElementById('fDia').value;
  const filtrados = historico.filter(h=>{
    const d=new Date(h.data);
    if(ano && d.getFullYear()!=ano) return false;
    if(mes && (d.getMonth()+1)!=mes) return false;
    if(dia && d.getDate()!=dia) return false;
    return true;
  });

  document.getElementById('dashVendas').textContent=filtrados.length;
  document.getElementById('dashFaturamento').textContent=BRL(filtrados.reduce((s,h)=>s+h.total,0));

  // itens e baixo estoque
  document.getElementById('dashItens').textContent=produtos.reduce((s,p)=>s+p.estoque,0);
  document.getElementById('dashBaixo').textContent=produtos.filter(p=>p.estoque<=3).length;

  // gráfico de barras: total por dia
  const mapDia={}; filtrados.forEach(h=>{const d=new Date(h.data).getDate(); mapDia[d]=(mapDia[d]||0)+h.total;});
  const ctx=document.getElementById('graficoBarras').getContext('2d');
  if(window.chartBarras) window.chartBarras.destroy();
  window.chartBarras=new Chart(ctx,{type:'bar',data:{labels:Object.keys(mapDia),datasets:[{label:'Faturamento',data:Object.values(mapDia)}]}});

  // pizza: quantidade por produto
  const mapProd={}; filtrados.forEach(h=>h.itens.forEach(i=>{mapProd[i.nome]=(mapProd[i.nome]||0)+i.qtd;}));
  const ctx2=document.getElementById('graficoPizza').getContext('2d');
  if(window.chartPizza) window.chartPizza.destroy();
  window.chartPizza=new Chart(ctx2,{type:'pie',data:{labels:Object.keys(mapProd),datasets:[{data:Object.values(mapProd)}]}});

  // saldo caixa
  document.getElementById('saldoCaixa').textContent=BRL(caixa.saldo||0);
}
function imprimirDashboard(){
  let dash=document.getElementById('dashboardCard').innerHTML;
  let w=window.open('','Dashboard');
  w.document.write(`
    <html><head>
      <title>Relatório Dashboard</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    </head><body class="p-3">
      <h3 class="text-center mb-3">Relatório - Dashboard</h3>
      ${dash}
      <script>
        setTimeout(()=>{ window.print(); window.close(); }, 600);
      <\/script>
    </body></html>
  `);
  w.document.close();
}

/* ========= CAIXA ========= */
function renderCaixa(){
  const ul=document.getElementById('listaCaixa'); if(!ul) return;
  ul.innerHTML='';
  caixa.movs.forEach(m=>{
    ul.innerHTML+=`<li class="list-group-item d-flex justify-content-between">
      <span>${new Date(m.data).toLocaleString('pt-BR')} — ${m.tipo.toUpperCase()} — ${m.desc||'-'}</span>
      <strong>${BRL(m.valor)}</strong>
    </li>`;
  });
  document.getElementById('saldoCaixa').textContent=BRL(caixa.saldo||0);
}
function registrarMovimento(){
  const tipo=document.getElementById('tipoMov').value;
  const valor=parseFloat(document.getElementById('valorMov').value);
  const desc=document.getElementById('descMov').value;
  if(isNaN(valor)||valor<=0) return alert('Informe um valor válido');

  if(tipo==='entrada') caixa.saldo+=valor; else caixa.saldo-=valor;
  caixa.movs.unshift({id:Date.now(),tipo,valor,desc,data:new Date().toISOString()});
  localStorage.setItem(KEY_CAIXA,JSON.stringify(caixa));
  renderCaixa();
  document.getElementById('valorMov').value=''; document.getElementById('descMov').value='';
}
function imprimirCaixa(){
  if(caixa.movs.length===0) return alert('Sem movimentos no caixa');
  let rel=`${EMPRESA_NOME}\nCNPJ: ${EMPRESA_CNPJ}\nCAIXA - MOVIMENTAÇÕES\n===========================\nSaldo atual: ${BRL(caixa.saldo)}\n\n`;
  caixa.movs.forEach(m=>{
    rel+=`${new Date(m.data).toLocaleString('pt-BR')} | ${m.tipo.toUpperCase()} | ${BRL(m.valor)} | ${m.desc||''}\n`;
  });
  const w=window.open('','Caixa'); w.document.write(`<pre>${rel}</pre>`); w.print(); w.close();
}

/* ========= INICIALIZAÇÃO ========= */
function boot(){
  renderProdutos();
  renderHistorico();
  renderCaixa();
  atualizarDashboard();
  toggleTroco();
  toggleCard('dashboardCard', document.querySelector('.menu a'));
}
boot();
</script>
</body>
</html>
