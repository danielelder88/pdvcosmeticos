<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>PDV Cosméticos — Completo (Local)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{--roxao:#6f42c1}
  body{background:#f8f9fa}
  .menu{width:260px;min-height:100vh;background:var(--roxao);color:#fff;position:fixed;inset:0 auto 0 0;padding:20px}
  .menu a{display:block;color:#fff;text-decoration:none;padding:10px 12px;margin:6px 0;border-radius:10px;cursor:pointer}
  .menu a.active,.menu a:hover{background:#55339e}
  .content{margin-left:280px;padding:20px}
  .card{border-radius:14px}
  #dashboardCard,#vendasCard,#produtosCard,#clientesCard,#relatoriosCard,#historicoCard,#caixaCard,#comprovanteCard,#configCard{display:none}
  #cupom{font-family:monospace;white-space:pre-wrap;background:#fff;padding:10px;border:1px dashed #ccc;max-width:360px;margin:auto}
  @media print{
    body *{visibility:hidden !important}
    #cupom,#cupom *{visibility:visible !important}
    #cupom{position:absolute;left:0;top:0;width:80mm;font-size:12px;line-height:1.3;border:none}
  }
  @media (max-width: 991px){.content{margin-left:0}.menu{display:none}}
  .fab{ position:fixed; right:16px; bottom:16px; z-index:1050; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.18); }
  .menu, main.content { display:none; } /* Oculta tudo até logar */
  .table-sm td,.table-sm th{padding:.45rem}
  .muted{color:#6c757d}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginCard" class="container mt-5">
  <div class="card p-4 mx-auto" style="max-width:420px">
    <h4 class="mb-3 text-center">Login PDV</h4>
    <div class="mb-3"><input id="loginUser" class="form-control" placeholder="Usuário (ex: admin)"></div>
    <div class="mb-3"><input id="loginPass" type="password" class="form-control" placeholder="Senha"></div>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="fazerLogin()">Entrar</button>
      <small class="text-muted">Admin inicial: <b>admin</b> / senha <b>1234</b></small>
    </div>
  </div>
</div>

<!-- MENU LATERAL (desktop) -->
<aside class="menu d-none d-lg-block">
  <h4 class="mb-3 d-flex align-items-center gap-2">
    <i class="bi bi-shop"></i> PDV
  </h4>
  <div class="small mb-2">Usuário: <b id="userLabel">—</b></div>
  <a onclick="toggleCard('dashboardCard',this)" class="active"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a onclick="toggleCard('vendasCard',this)"><i class="bi bi-cart me-2"></i>Vendas</a>
  <a onclick="toggleCard('produtosCard',this)"><i class="bi bi-box-seam me-2"></i>Produtos</a>
  <a onclick="toggleCard('clientesCard',this)"><i class="bi bi-people me-2"></i>Clientes</a>
  <a onclick="toggleCard('relatoriosCard',this)"><i class="bi bi-graph-up-arrow me-2"></i>Relatórios</a>
  <a onclick="toggleCard('historicoCard',this)"><i class="bi bi-receipt me-2"></i>Histórico</a>
  <a onclick="toggleCard('caixaCard',this)"><i class="bi bi-cash-coin me-2"></i>Caixa</a>
  <a onclick="toggleCard('comprovanteCard',this)"><i class="bi bi-printer me-2"></i>Comprovante</a>
  <a onclick="toggleCard('configCard',this)"><i class="bi bi-gear me-2"></i>Configurações</a>
  <hr class="border-light">
  <a onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Sair</a>
</aside>

<!-- MENU MOBILE (offcanvas) -->
<nav class="navbar navbar-dark bg-primary d-lg-none">
  <div class="container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuMobile"><span class="navbar-toggler-icon"></span></button>
    <span class="navbar-brand">PDV</span>
  </div>
</nav>
<div class="offcanvas offcanvas-start bg-primary text-white" tabindex="-1" id="menuMobile">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title"><i class="bi bi-shop"></i> PDV</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="small mb-2">Usuário: <b id="userLabelMobile">—</b></div>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('dashboardCard')">Dashboard</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('vendasCard')">Vendas</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('produtosCard')">Produtos</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('clientesCard')">Clientes</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('relatoriosCard')">Relatórios</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('historicoCard')">Histórico</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('caixaCard')">Caixa</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('comprovanteCard')">Comprovante</a>
    <a class="d-block text-white mb-2" data-bs-dismiss="offcanvas" onclick="toggleCard('configCard')">Configurações</a>
    <a class="d-block text-white mt-3" onclick="logout()">Sair</a>
  </div>
</div>

<!-- CONTEÚDO -->
<main class="content">
  <div class="container-fluid">

    <!-- DASHBOARD -->
    <section id="dashboardCard">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted">Vendas (Hoje)</div>
                <h4 id="dashVendasHoje">0</h4>
              </div>
              <i class="bi bi-basket2 display-6 text-primary"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted">Faturamento (Hoje)</div>
                <h4 id="dashFatHoje">R$ 0,00</h4>
              </div>
              <i class="bi bi-currency-dollar display-6 text-success"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted">Clientes</div>
                <h4 id="dashClientes">0</h4>
              </div>
              <i class="bi bi-people display-6 text-warning"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="muted">Produtos</div>
                <h4 id="dashProdutos">0</h4>
              </div>
              <i class="bi bi-box-seam display-6 text-info"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="card p-3 mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Gráfico — Vendas (7 dias)</h5>
          <small class="muted">Atualiza a cada venda</small>
        </div>
        <canvas id="chart7dias" height="80"></canvas>
      </div>
    </section>

    <!-- VENDAS -->
    <section id="vendasCard">
      <div class="row g-3">
        <div class="col-lg-7">
          <div class="card p-3">
            <h5>Adicionar itens</h5>
            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Produto</label>
                <select id="selProduto" class="form-select"></select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Qtd</label>
                <input id="qtd" type="number" min="1" value="1" class="form-control">
              </div>
              <div class="col-md-3 d-grid">
                <button class="btn btn-primary" onclick="adicionarProdutoCarrinho()">
                  <i class="bi bi-plus-lg me-1"></i>Adicionar
                </button>
              </div>
            </div>
            <hr>
            <ul id="listaCarrinho" class="list-group"></ul>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="card p-3">
            <h5>Resumo</h5>
            <div class="row g-2">
              <div class="col-6">
                <div class="muted">Total</div>
                <div id="totalVenda" class="h4 mb-0">R$ 0,00</div>
              </div>
              <div class="col-6">
                <label class="form-label">Cliente</label>
                <select id="selCliente" class="form-select"></select>
              </div>
              <div class="col-6">
                <label class="form-label">Desconto (R$)</label>
                <input id="desconto" type="number" step="0.01" class="form-control" value="0" oninput="renderCarrinho()">
              </div>
              <div class="col-6">
                <label class="form-label">Acréscimo (R$)</label>
                <input id="acrescimo" type="number" step="0.01" class="form-control" value="0" oninput="renderCarrinho()">
              </div>
              <div class="col-6">
                <label class="form-label">Pagamento</label>
                <select id="pagamento" class="form-select">
                  <option>Dinheiro</option>
                  <option>Pix</option>
                  <option>Crédito</option>
                  <option>Débito</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">Valor pago</label>
                <input id="valorPago" type="number" step="0.01" class="form-control" value="0" oninput="calcularTroco()">
              </div>
              <div class="col-6">
                <div class="muted">Troco</div>
                <div id="troco" class="h5 mb-2">R$ 0,00</div>
              </div>
              <div class="col-6">
                <div class="muted">Comissão</div>
                <div class="h6 mb-2"><span id="comissaoPctLabel">5%</span> • <span id="comissaoValor">R$ 0,00</span></div>
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-success" onclick="finalizarVenda()">
                  <i class="bi bi-check2-circle me-1"></i>Finalizar venda
                </button>
              </div>
              <div class="col-12">
                <small class="muted">Após finalizar, o cupom é gerado em “Comprovante”.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="produtosCard">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card p-3">
            <h5>Cadastrar / Editar produto</h5>
<div class="mb-2">
  <label class="form-label">Quantidade em estoque</label>
  <input id="pQtd" type="number" min="0" class="form-control">
</div>
            <div class="mb-2">
              <label class="form-label">Nome</label>
              <input id="pNome" class="form-control">
            </div>
            <div class="mb-2">
              <label class="form-label">Preço (R$)</label>
              <input id="pPreco" type="number" step="0.01" class="form-control">
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="salvarProduto()"><i class="bi bi-save me-1"></i>Salvar</button>
              <button class="btn btn-secondary" onclick="limparFormProduto()">Limpar</button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Lista de produtos</h5>
              <input id="buscaProduto" class="form-control w-auto" placeholder="Buscar..." oninput="renderProdutos()">
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm align-middle">
                <thead><tr><th>#</th><th>Produto</th><th>Preço</th><th>Qtd</th><th class="text-end">Ações</th></tr></thead>
                <tbody id="tProdutos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientesCard">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card p-3">
            <h5>Cadastrar / Editar cliente</h5>
            <div class="mb-2"><label class="form-label">Nome</label><input id="cNome" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Telefone</label><input id="cTelefone" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Email</label><input id="cEmail" class="form-control"></div>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="salvarCliente()"><i class="bi bi-save me-1"></i>Salvar</button>
              <button class="btn btn-secondary" onclick="limparFormCliente()">Limpar</button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Lista de clientes</h5>
              <input id="buscaCliente" class="form-control w-auto" placeholder="Buscar..." oninput="listarClientes()">
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm align-middle">
                <thead><tr><th>#</th><th>Nome</th><th>Telefone</th><th>Email</th><th class="text-end">Ações</th></tr></thead>
                <tbody id="tClientes"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RELATÓRIOS -->
    <section id="relatoriosCard">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card p-3">
            <h5>Vendas por forma de pagamento (30 dias)</h5>
            <canvas id="chartPagto" height="120"></canvas>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card p-3">
            <h5>Comissões (30 dias)</h5>
            <div class="h4" id="relComissaoTotal">R$ 0,00</div>
            <small class="muted">Percentual padrão: <span id="relComissaoPct">5%</span></small>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTÓRICO -->
    <section id="historicoCard">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Histórico de vendas</h5>
          <small class="muted">Mais recentes primeiro</small>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead><tr><th>Data</th><th>Itens</th><th>Total</th><th>Pagamento</th><th>Vendedor</th><th>Comissão</th><th></th></tr></thead>
            <tbody id="tHistorico"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CAIXA -->
    <section id="caixaCard">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card p-3">
            <h5>Registrar movimento</h5>
            <div class="mb-2">
              <label class="form-label">Tipo</label>
              <select id="cxTipo" class="form-select">
                <option value="Entrada">Entrada</option>
                <option value="Saída">Saída</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Descrição</label>
              <input id="cxDesc" class="form-control">
            </div>
            <div class="mb-2">
              <label class="form-label">Valor (R$)</label>
              <input id="cxValor" type="number" step="0.01" class="form-control">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" onclick="registrarCaixa()">Salvar</button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Movimentos</h5>
              <div class="h6 mb-0">Saldo: <span id="cxSaldo">R$ 0,00</span></div>
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm align-middle">
                <thead><tr><th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th><th class="text-end">Ações</th></tr></thead>
                <tbody id="tCaixa"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- COMPROVANTE -->
    <section id="comprovanteCard">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Comprovante (Cupom)</h5>
          <button class="btn btn-outline-secondary btn-sm" onclick="window.print()"><i class="bi bi-printer me-1"></i>Imprimir</button>
        </div>
        <div id="cupom" class="mt-3">Nenhum cupom gerado ainda.</div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="configCard">
      <div class="card p-3">
        <h5>Configurações</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Comissão padrão (%)</label>
            <input id="cfgComissao" type="number" step="0.1" class="form-control">
          </div>
          <div class="col-md-8 d-flex align-items-end gap-2">
            <button class="btn btn-primary" onclick="salvarConfig()">Salvar</button>
            <small class="muted">Usada no cálculo de comissão das vendas.</small>
          </div>
        </div>
        <hr>
        <h6>Usuários</h6>
        <div class="row g-2">
          <div class="col-md-3"><input id="uUsuario" class="form-control" placeholder="Usuário"></div>
          <div class="col-md-3"><input id="uSenha" type="password" class="form-control" placeholder="Senha"></div>
          <div class="col-md-3">
            <select id="uNivel" class="form-select">
              <option value="admin">admin</option>
              <option value="vendedor">vendedor</option>
            </select>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-secondary" onclick="adicionarUsuario()">Adicionar</button>
          </div>
        </div>
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle">
            <thead><tr><th>#</th><th>Usuário</th><th>Nível</th><th class="text-end">Ações</th></tr></thead>
            <tbody id="tUsuarios"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- BOTÃO FLUTUANTE PARA VENDAS -->
<button class="btn btn-primary fab d-none d-lg-flex" onclick="toggleCard('vendasCard')"><i class="bi bi-plus-lg"></i></button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= Helpers ========= */
const money = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const getLS = (k,def)=>{ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); }catch(e){ return def; }};
const setLS = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
const uid = () => Date.now() + Math.random().toString(36).slice(2,8);

/* ========= Estado ========= */
let usuarios = getLS('pdv_usuarios', []);
let produtos = getLS('pdv_produtos', []);
let clientes = getLS('pdv_clientes', []);
let vendas = getLS('pdv_vendas', []);
let caixa = getLS('pdv_caixa', []);
let usuarioLogado = null;
let carrinho = getLS('pdv_carrinho', []);
let comissaoPadrao = Number(localStorage.getItem('pdv_comissao') || 5);

/* Seed inicial */
if(usuarios.length===0){
  usuarios.push({ usuario:"admin", senha:"1234", nivel:"admin" });
  setLS('pdv_usuarios', usuarios);
}
if(produtos.length===0){
  produtos = [
    {id:uid(), nome:"Shampoo 300ml", preco:19.90},
    {id:uid(), nome:"Condicionador 300ml", preco:22.50},
    {id:uid(), nome:"Hidratante 200g", preco:28.00}
  ]; setLS('pdv_produtos', produtos);
}

/* ========= Navegação ========= */
function toggleCard(id, el){
  document.querySelectorAll('main .container-fluid > section').forEach(s=>s.style.display='none');
  const card = document.getElementById(id);
  if(card){ card.style.display='block'; }
  document.querySelectorAll('.menu a').forEach(a=>a.classList.remove('active'));
  if(el) el.classList.add('active');

  // Atualiza seções
  if(id==='dashboardCard') renderDashboard();
  if(id==='vendasCard'){ preencherSelectProdutos(); preencherSelectClientes(); renderCarrinho(); }
  if(id==='produtosCard') renderProdutos();
  if(id==='clientesCard') listarClientes();
  if(id==='relatoriosCard'){ renderChartPagto(); renderRelComissao(); }
  if(id==='historicoCard') renderHistorico();
  if(id==='caixaCard') renderCaixa();
  if(id==='comprovanteCard'){} // nada
  if(id==='configCard'){ document.getElementById('cfgComissao').value = comissaoPadrao; renderUsuarios(); }
}

/* ========= Login ========= */
function fazerLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const user = usuarios.find(x=>x.usuario===u && x.senha===p);
  if(!user) return alert('Usuário ou senha inválidos');

  usuarioLogado = { usuario: user.usuario, nivel: user.nivel };
  setLS('pdv_usuario', usuarioLogado);

  document.getElementById('loginCard').style.display = 'none';
  document.querySelector('.menu').style.display = 'block';
  document.querySelector('main.content').style.display = 'block';

  document.getElementById('userLabel').textContent = usuarioLogado.usuario + ' ('+usuarioLogado.nivel+')';
  document.getElementById('userLabelMobile').textContent = usuarioLogado.usuario + ' ('+usuarioLogado.nivel+')';
  document.getElementById('comissaoPctLabel').textContent = comissaoPadrao + '%';

  // Restrições para vendedor
  if(usuarioLogado.nivel === 'vendedor'){
    document.querySelector("[onclick*='produtosCard']").style.display = 'none';
    document.querySelector("[onclick*='relatoriosCard']").style.display = 'none';
    document.querySelector("[onclick*='caixaCard']").style.display = 'none';
    document.querySelector("[onclick*='configCard']").style.display = 'none';
  }
  toggleCard('dashboardCard');
}
function logout(){ localStorage.removeItem('pdv_usuario'); usuarioLogado=null; location.reload(); }
window.addEventListener('load', ()=>{
  const u = getLS('pdv_usuario', null);
  if(u){
    usuarioLogado = u;
    document.getElementById('loginCard').style.display = 'none';
    document.querySelector('.menu').style.display = 'block';
    document.querySelector('main.content').style.display = 'block';
    document.getElementById('userLabel').textContent = usuarioLogado.usuario + ' ('+usuarioLogado.nivel+')';
    document.getElementById('userLabelMobile').textContent = usuarioLogado.usuario + ' ('+usuarioLogado.nivel+')';
    document.getElementById('comissaoPctLabel').textContent = comissaoPadrao + '%';
    toggleCard('dashboardCard');
  }
});

/* ========= Dashboard ========= */
let chart7 = null;
function renderDashboard(){
  // KPI hoje
  const hoje = new Date().toDateString();
  let vendasHoje = vendas.filter(v=> new Date(v.data).toDateString()===hoje );
  const totalHoje = vendasHoje.reduce((a,b)=>a + Number(b.totalFinal||0), 0);
  document.getElementById('dashVendasHoje').textContent = vendasHoje.length;
  document.getElementById('dashFatHoje').textContent = money(totalHoje);
  document.getElementById('dashClientes').textContent = clientes.length;
  document.getElementById('dashProdutos').textContent = produtos.length;

  // 7 dias
  const labels=[], values=[];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toDateString();
    labels.push(d.toLocaleDateString());
    values.push( vendas.filter(v => new Date(v.data).toDateString()===ds)
                      .reduce((a,b)=>a+Number(b.totalFinal||0),0) );
  }
  const ctx = document.getElementById('chart7dias');
  if(chart7) chart7.destroy();
  chart7 = new Chart(ctx,{type:'line', data:{labels, datasets:[{label:'Faturamento', data:values, tension:.3}]}});
}

/* ========= Produtos ========= */
function limparFormProduto(){
  document.getElementById('pNome').value='';
  document.getElementById('pPreco').value='';
  document.getElementById('pQtd').value='';
}
function salvarProduto(){
  const nome = document.getElementById('pNome').value.trim();
  const preco = Number(document.getElementById('pPreco').value);
  const qtd = Number(document.getElementById('pQtd').value || 0);

  if(!nome || !preco){ alert('Preencha nome e preço'); return; }

  const idx = produtos.findIndex(p=>p.nome.toLowerCase()===nome.toLowerCase());
  if(idx>=0){
    produtos[idx].preco = preco;
    produtos[idx].qtd = qtd;
  } else {
    produtos.push({id:uid(), nome, preco, qtd});
  }
  setLS('pdv_produtos', produtos);
  limparFormProduto();
  renderProdutos(); preencherSelectProdutos();
}
function removerProduto(id){
  if(!confirm('Remover produto?')) return;
  produtos = produtos.filter(p=>p.id!==id);
  setLS('pdv_produtos', produtos);
  renderProdutos(); preencherSelectProdutos();
tr.innerHTML = `<td>${i+1}</td>
<td>${p.nome}</td>
<td>${money(p.preco)}</td>
<td>${p.qtd ?? 0}</td>
<td class="text-end">
  <button class="btn btn-sm btn-outline-secondary me-1" onclick="editarProduto('${p.id}')"><i class="bi bi-pencil"></i></button>
  <button class="btn btn-sm btn-outline-danger" onclick="removerProduto('${p.id}')"><i class="bi bi-trash"></i></button>
</td>`;
}
function editarProduto(id){
  const p = produtos.find(x=>x.id===id);
  if(!p) return;
  document.getElementById('pNome').value = p.nome;
  document.getElementById('pPreco').value = p.preco;
  window.scrollTo({top:0, behavior:'smooth'});
}
function renderProdutos(){
  const busca = (document.getElementById('buscaProduto')?.value || '').toLowerCase();
  const tbody = document.getElementById('tProdutos'); tbody.innerHTML='';
  produtos.filter(p=>p.nome.toLowerCase().includes(busca))
    .forEach((p,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${p.nome}</td><td>${money(p.preco)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="editarProduto('${p.id}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" onclick="removerProduto('${p.id}')"><i class="bi bi-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    });
}

/* ========= Clientes ========= */
function limparFormCliente(){ ['cNome','cTelefone','cEmail'].forEach(id=>document.getElementById(id).value=''); }
function salvarCliente(){
  const nome = document.getElementById('cNome').value.trim();
  const telefone = document.getElementById('cTelefone').value.trim();
  const email = document.getElementById('cEmail').value.trim();
  if(!nome){ alert('Informe o nome'); return; }
  const idx = clientes.findIndex(c=>c.nome.toLowerCase()===nome.toLowerCase());
  if(idx>=0) clientes[idx] = {nome, telefone, email};
  else clientes.push({nome, telefone, email});
  setLS('pdv_clientes', clientes);
  limparFormCliente(); listarClientes(); preencherSelectClientes(); renderDashboard();
}
function removerCliente(nome){
  if(!confirm('Remover cliente?')) return;
  clientes = clientes.filter(c=>c.nome!==nome);
  setLS('pdv_clientes', clientes);
  listarClientes(); preencherSelectClientes(); renderDashboard();
}
function editarCliente(nome){
  const c = clientes.find(x=>x.nome===nome);
  if(!c) return;
  document.getElementById('cNome').value = c.nome;
  document.getElementById('cTelefone').value = c.telefone||'';
  document.getElementById('cEmail').value = c.email||'';
  window.scrollTo({top:0, behavior:'smooth'});
}
function listarClientes(){
  const busca = (document.getElementById('buscaCliente')?.value || '').toLowerCase();
  const tbody = document.getElementById('tClientes'); tbody.innerHTML='';
  clientes.filter(c=>c.nome.toLowerCase().includes(busca))
    .forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${c.nome}</td><td>${c.telefone||'-'}</td><td>${c.email||'-'}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editarCliente('${c.nome.replace(/'/g,"\\'")}')"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="removerCliente('${c.nome.replace(/'/g,"\\'")}')"><i class="bi bi-trash"></i></button>
      </td>`;
      tbody.appendChild(tr);
    });
}

/* ========= Seletores para vendas ========= */
function preencherSelectProdutos(){
  const sel = document.getElementById('selProduto'); sel.innerHTML='';
  produtos.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = `${p.nome} — ${money(p.preco)}`;
    sel.appendChild(opt);
  });
}
function preencherSelectClientes(){
  const sel = document.getElementById('selCliente'); sel.innerHTML='';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='Consumidor final'; sel.appendChild(opt0);
  clientes.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.nome; opt.textContent = c.nome;
    sel.appendChild(opt);
  });
}

/* ========= Carrinho / Vendas ========= */
function adicionarProdutoCarrinho(){
  const id = document.getElementById('selProduto').value;
  const qtd = Math.max(1, Number(document.getElementById('qtd').value||1));
  const p = produtos.find(x=>x.id===id);
  if(!p) return;
  const idx = carrinho.findIndex(i=>i.id===id);
  if(idx>=0){ carrinho[idx].qtd += qtd; }
  else carrinho.push({id:p.id, nome:p.nome, preco:Number(p.preco), qtd});
  setLS('pdv_carrinho', carrinho);
  document.getElementById('qtd').value = 1;
  renderCarrinho();
}
function editarQtd(i){
  const nova = Number(prompt('Quantidade:', carrinho[i].qtd));
  if(!nova || nova<=0) return;
  carrinho[i].qtd = Math.floor(nova);
  setLS('pdv_carrinho', carrinho);
  renderCarrinho();
}
function removerCarrinho(i){
  carrinho.splice(i,1);
  setLS('pdv_carrinho', carrinho);
  renderCarrinho();
}
function totalDoCarrinho(){
  return carrinho.reduce((a,b)=>a + b.preco*b.qtd, 0);
}
function calcularTroco(){
  const desconto = Number(document.getElementById('desconto').value||0);
  const acrescimo = Number(document.getElementById('acrescimo').value||0);
  const valorPago = Number(document.getElementById('valorPago').value||0);
  const totalBase = totalDoCarrinho();
  const totalFinal = Math.max(0, totalBase - desconto + acrescimo);
  const troco = Math.max(0, valorPago - totalFinal);
  document.getElementById('troco').textContent = money(troco);
  // comissão
  const comiss = totalFinal * (Number(comissaoPadrao)/100);
  document.getElementById('comissaoValor').textContent = money(comiss);
  return { totalFinal, troco, comiss };
}
function renderCarrinho(){
  const ul = document.getElementById('listaCarrinho'); ul.innerHTML='';
  carrinho.forEach((it,i)=>{
    const li = document.createElement('li');
    li.className='list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<div><b>${it.nome}</b> <span class="muted">x${it.qtd}</span><br><small>${money(it.preco)}</small></div>
      <div>
        <button class='btn btn-sm btn-outline-secondary me-1' onclick='editarQtd(${i})'><i class='bi bi-pencil'></i></button>
        <button class='btn btn-sm btn-outline-danger' onclick='removerCarrinho(${i})'><i class='bi bi-trash'></i></button>
      </div>`;
    ul.appendChild(li);
  });
  document.getElementById('totalVenda').textContent = money(totalDoCarrinho());
  calcularTroco();
}
function finalizarVenda(){
  if(carrinho.length===0){ alert('Carrinho vazio'); return; }
  const { totalFinal, comiss } = calcularTroco();
  const venda = {
    id: uid(),
    data: new Date().toISOString(),
    itens: carrinho.map(i=>({id:i.id,nome:i.nome,preco:i.preco,qtd:i.qtd})),
    total: totalDoCarrinho(),
    desconto: Number(document.getElementById('desconto').value||0),
    acrescimo: Number(document.getElementById('acrescimo').value||0),
    totalFinal,
    pagamento: document.getElementById('pagamento').value,
    cliente: document.getElementById('selCliente').value || 'Consumidor final',
    vendedor: (usuarioLogado?.usuario)||'—',
    commission: comiss
  };
  vendas.unshift(venda);
  setLS('pdv_vendas', vendas);
// Atualiza estoque dos produtos
venda.itens.forEach(item=>{
  const prod = produtos.find(p=>p.id===item.id);
  if(prod){
    prod.qtd = (prod.qtd || 0) - item.qtd;
    if(prod.qtd <= 0){
      prod.qtd = 0;
      alert(`⚠️ Estoque do produto "${prod.nome}" acabou!`);
    }
  }
});
setLS('pdv_produtos', produtos);
renderProdutos();

  // Caixa automático (entrada)
  caixa.unshift({ id: uid(), data: venda.data, tipo: 'Entrada', desc: `Venda ${venda.id.slice(-6)} (${venda.pagamento})`, valor: venda.totalFinal });
  setLS('pdv_caixa', caixa);

  // Gera cupom
  gerarCupom(venda);

  // Limpa carrinho
  carrinho = [];
  setLS('pdv_carrinho', carrinho);

  // Reseta campos
  document.getElementById('desconto').value = 0;
  document.getElementById('acrescimo').value = 0;
  document.getElementById('valorPago').value = 0;

  // Atualiza telas
  renderCarrinho(); renderDashboard(); renderHistorico(); renderCaixa();
  toggleCard('comprovanteCard');
}
function gerarCupom(v){
  let linhas = [];
  linhas.push('DRICCA COSMÉTICOS');
  linhas.push('------------------------------');
  linhas.push('Data: ' + new Date(v.data).toLocaleString());
  linhas.push('Cliente: ' + v.cliente);
  linhas.push('Vendedor: ' + v.vendedor);
  linhas.push('------------------------------');
  v.itens.forEach(i=>{
    linhas.push(`${i.nome}`);
    linhas.push(`  ${i.qtd} x ${money(i.preco)} = ${money(i.preco*i.qtd)}`);
  });
  linhas.push('------------------------------');
  linhas.push(`Subtotal: ${money(v.total)}`);
  if(v.desconto) linhas.push(`Desconto: - ${money(v.desconto)}`);
  if(v.acrescimo) linhas.push(`Acréscimo: + ${money(v.acrescimo)}`);
  linhas.push(`TOTAL: ${money(v.totalFinal)}`);
  linhas.push(`Pagamento: ${v.pagamento}`);
  linhas.push(`Comissão (${comissaoPadrao}%): ${money(v.commission)}`);
  linhas.push('------------------------------');
  linhas.push('Obrigado pela preferência!');
  document.getElementById('cupom').textContent = linhas.join('\n');
}
function gerarCupomRecuperar(id){
  const v = vendas.find(x=>x.id===id);
  if(!v) return;
  gerarCupom(v);
  toggleCard('comprovanteCard');
}

/* ========= Histórico ========= */
function renderHistorico(){
  const tbody = document.getElementById('tHistorico'); tbody.innerHTML='';
  vendas.forEach(v=>{
    const itens = v.itens.map(i=>i.nome+' x'+i.qtd).join(', ');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(v.data).toLocaleString()}</td>
      <td>${itens}</td>
      <td>${money(v.totalFinal)}</td>
      <td>${v.pagamento}</td>
      <td>${v.vendedor}</td>
      <td>${money(v.commission||0)}</td>
      <td><button class='btn btn-sm btn-outline-secondary' title='Cupom' onclick='gerarCupomRecuperar("${v.id}")'><i class="bi bi-printer"></i></button></td>`;
    tbody.appendChild(tr);
  });
}

/* ========= Caixa ========= */
function registrarCaixa(){
  const tipo = document.getElementById('cxTipo').value;
  const desc = document.getElementById('cxDesc').value.trim();
  const valor = Number(document.getElementById('cxValor').value);
  if(!valor || !desc){ alert('Informe descrição e valor'); return; }
  caixa.unshift({ id:uid(), data:new Date().toISOString(), tipo, desc, valor: (tipo==='Saída'?-Math.abs(valor):Math.abs(valor)) });
  setLS('pdv_caixa', caixa);
  document.getElementById('cxDesc').value=''; document.getElementById('cxValor').value='';
  renderCaixa();
}
function removerCaixa(id){
  if(!confirm('Remover lançamento?')) return;
  caixa = caixa.filter(c=>c.id!==id); setLS('pdv_caixa', caixa); renderCaixa();
}
function renderCaixa(){
  const tbody = document.getElementById('tCaixa'); tbody.innerHTML='';
  let saldo = 0;
  caixa.forEach(c=>{
    saldo += Number(c.valor||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(c.data).toLocaleString()}</td>
      <td>${c.tipo}</td>
      <td>${c.desc}</td>
      <td>${money(c.valor)}</td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerCaixa('${c.id}')"><i class="bi bi-trash"></i></button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('cxSaldo').textContent = money(saldo);
}

/* ========= Relatórios ========= */
let chartPagto = null;
function renderChartPagto(){
  const m = {Dinheiro:0, Pix:0, Crédito:0, Débito:0};
  const limite = new Date(); limite.setDate(limite.getDate()-30);
  vendas.filter(v=> new Date(v.data)>=limite)
    .forEach(v=>{ m[v.pagamento] = (m[v.pagamento]||0) + Number(v.totalFinal||0); });
  const ctx = document.getElementById('chartPagto');
  if(chartPagto) chartPagto.destroy();
  chartPagto = new Chart(ctx,{type:'bar', data:{labels:Object.keys(m), datasets:[{label:'R$', data:Object.values(m)}]}} );
}
function renderRelComissao(){
  const limite = new Date(); limite.setDate(limite.getDate()-30);
  const total = vendas.filter(v=> new Date(v.data)>=limite)
    .reduce((a,b)=>a + Number(b.commission||0), 0);
  document.getElementById('relComissaoTotal').textContent = money(total);
  document.getElementById('relComissaoPct').textContent = comissaoPadrao + '%';
}

/* ========= Config / Usuários ========= */
function salvarConfig(){
  comissaoPadrao = Number(document.getElementById('cfgComissao').value||5);
  localStorage.setItem('pdv_comissao', comissaoPadrao);
  document.getElementById('comissaoPctLabel').textContent = comissaoPadrao + '%';
  alert('Configurações salvas.');
}
function adicionarUsuario(){
  const usuario = document.getElementById('uUsuario').value.trim();
  const senha = document.getElementById('uSenha').value.trim();
  const nivel = document.getElementById('uNivel').value;
  if(!usuario || !senha){ alert('Informe usuário e senha'); return; }
  if(usuarios.find(u=>u.usuario===usuario)){ alert('Usuário já existe'); return; }
  usuarios.push({usuario, senha, nivel});
  setLS('pdv_usuarios', usuarios);
  document.getElementById('uUsuario').value=''; document.getElementById('uSenha').value='';
  renderUsuarios();
}
function removerUsuario(usuario){
  if(usuario==='admin'){ alert('Não é permitido remover o admin padrão.'); return; }
  if(!confirm('Remover usuário?')) return;
  usuarios = usuarios.filter(u=>u.usuario!==usuario);
  setLS('pdv_usuarios', usuarios);
  renderUsuarios();
}
function renderUsuarios(){
  const tbody = document.getElementById('tUsuarios'); tbody.innerHTML='';
  usuarios.forEach((u,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${u.usuario}</td><td>${u.nivel}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-danger" onclick="removerUsuario('${u.usuario}')"><i class="bi bi-trash"></i></button>
      </td>`;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
